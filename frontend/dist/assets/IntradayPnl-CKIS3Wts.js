import{r as o,j as e}from"./vendor-react-CCyQGCED.js";import{d as V,g as H,B as M,c as i,s as W}from"./index-D5bUJiSk.js";import{t as O}from"./trading-CWJ8Diu_.js";import{C as p,d as N,a as P,c as S,b as v}from"./card-BhiC3MvD.js";import{S as b}from"./skeleton-BGHfe5Jq.js";import{u as Y}from"./useLivePrice-Be1T3zjE.js";import{Y as G,u as K,n as J,a2 as X,c as Z,a3 as ee}from"./vendor-icons-CCn_k3dF.js";import"./vendor-charts-l0_txfiz.js";import"./vendor-router-Dzc1xxhr.js";import"./vendor-radix-CYVJEJRR.js";import"./useMarketStatus-DNRUt99l.js";function q(m){const j=Math.abs(m),f=new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",minimumFractionDigits:2,maximumFractionDigits:2}).format(j);return m<0?`-${f}`:f}function d(m){return m>0?`+${q(m)}`:q(m)}function xe(){const{apiKey:m}=V(),[j,f]=o.useState([]),[E,w]=o.useState(!0),[L,R]=o.useState(!1),[z,Q]=o.useState(null),[_,$]=o.useState(new Set),{wasHidden:B,timeSinceHidden:C}=H(),g=o.useCallback(async(s=!1)=>{if(m){s?R(!0):w(!0);try{const t=await O.getTrades(m);t.status==="success"&&t.data?(f(t.data),Q(null)):Q(t.message||"Failed to fetch trades")}catch(t){Q("Failed to fetch tradebook"),console.error("Tradebook fetch error:",t)}finally{w(!1),R(!1)}}},[m]);o.useEffect(()=>{g()},[g]),o.useEffect(()=>{B&&C>3e4&&g(!0)},[B,C,g]);const U=o.useMemo(()=>{const s=new Map;return j.forEach(t=>{const a=t.strategy||"Untagged",u=`${a}:${t.symbol}:${t.exchange}`,l=s.get(u);if(l){if(t.action==="BUY"){const r=l.avgBuyPrice*l.buyQty+t.average_price*t.quantity;l.buyQty+=t.quantity,l.avgBuyPrice=l.buyQty>0?r/l.buyQty:0}else{const r=l.avgSellPrice*l.sellQty+t.average_price*t.quantity;l.sellQty+=t.quantity,l.avgSellPrice=l.sellQty>0?r/l.sellQty:0}l.netQty=l.buyQty-l.sellQty,l.quantity=Math.abs(l.netQty),l.average_price=l.netQty>0?l.avgBuyPrice:l.avgSellPrice}else{const r=t.action==="BUY";s.set(u,{symbol:t.symbol,exchange:t.exchange,strategy:a,buyQty:r?t.quantity:0,sellQty:r?0:t.quantity,netQty:r?t.quantity:-t.quantity,avgBuyPrice:r?t.average_price:0,avgSellPrice:r?0:t.average_price,ltp:0,realizedPnl:0,unrealizedPnl:0,product:t.product,quantity:t.quantity,average_price:t.average_price})}}),Array.from(s.values())},[j]),{data:T,isLive:A}=Y(U,{enabled:U.length>0,useMultiQuotesFallback:!0,pauseWhenHidden:!0}),h=o.useMemo(()=>{const s=new Map;return T.forEach(t=>{const a=t.strategy||"Untagged",u=Math.min(t.buyQty,t.sellQty),l=t.netQty,r=t.ltp||0;let x=0;u>0&&t.avgBuyPrice>0&&t.avgSellPrice>0&&(x=(t.avgSellPrice-t.avgBuyPrice)*u);let n=0;if(l!==0&&r>0){const k=l>0?t.avgBuyPrice:t.avgSellPrice;l>0?n=(r-k)*l:n=(k-r)*Math.abs(l)}const F={...t,ltp:r,realizedPnl:x,unrealizedPnl:n},y=s.get(a);y?(y.legs.push(F),y.totalRealizedPnl+=x,y.totalUnrealizedPnl+=n,y.totalPnl=y.totalRealizedPnl+y.totalUnrealizedPnl):s.set(a,{name:a,legs:[F],totalRealizedPnl:x,totalUnrealizedPnl:n,totalPnl:x+n})}),Array.from(s.values()).sort((t,a)=>t.name.localeCompare(a.name))},[T]),c=o.useMemo(()=>h.reduce((s,t)=>({realizedPnl:s.realizedPnl+t.totalRealizedPnl,unrealizedPnl:s.unrealizedPnl+t.totalUnrealizedPnl,totalPnl:s.totalPnl+t.totalPnl}),{realizedPnl:0,unrealizedPnl:0,totalPnl:0}),[h]),I=s=>{$(t=>{const a=new Set(t);return a.has(s)?a.delete(s):a.add(s),a})},D=()=>{const s=["Strategy","Symbol","Exchange","Buy Qty","Sell Qty","Net Qty","Avg Buy Price","Avg Sell Price","LTP","Realized P&L","Unrealized P&L","Total P&L"],t=h.flatMap(x=>x.legs.map(n=>[x.name,n.symbol,n.exchange,n.buyQty,n.sellQty,n.netQty,n.avgBuyPrice.toFixed(2),n.avgSellPrice.toFixed(2),n.ltp.toFixed(2),n.realizedPnl.toFixed(2),n.unrealizedPnl.toFixed(2),(n.realizedPnl+n.unrealizedPnl).toFixed(2)])),a=[s.join(","),...t.map(x=>x.join(","))].join(`
`),u=new Blob([a],{type:"text/csv"}),l=URL.createObjectURL(u),r=document.createElement("a");r.href=l,r.download=`intraday_pnl_${new Date().toISOString().split("T")[0]}.csv`,r.click(),URL.revokeObjectURL(l),W.success("CSV exported successfully","system")};return E?e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(b,{className:"h-8 w-48"}),e.jsx(b,{className:"h-10 w-32"})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-3",children:[1,2,3].map(s=>e.jsx(b,{className:"h-24"},s))}),e.jsx(b,{className:"h-64"})]}):e.jsxs("div",{className:"container mx-auto py-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Intraday P&L"}),e.jsxs("p",{className:"text-muted-foreground",children:["Today's strategy-wise P&L from tradebook",A&&e.jsxs("span",{className:"ml-2 inline-flex items-center gap-1 text-green-600",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-green-500 animate-pulse"}),"Live"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>g(!0),disabled:L,children:[e.jsx(G,{className:i("h-4 w-4 mr-2",L&&"animate-spin")}),"Refresh"]}),e.jsxs(M,{variant:"outline",size:"sm",onClick:D,disabled:h.length===0,children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]})]}),z&&e.jsx(p,{className:"border-destructive",children:e.jsx(N,{className:"pt-6",children:e.jsx("p",{className:"text-destructive",children:z})})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsx(p,{children:e.jsxs(P,{className:"pb-2",children:[e.jsx(S,{children:"Realized P&L"}),e.jsx(v,{className:i("text-2xl",c.realizedPnl>=0?"text-green-600":"text-red-600"),children:d(c.realizedPnl)})]})}),e.jsx(p,{children:e.jsxs(P,{className:"pb-2",children:[e.jsx(S,{children:"Unrealized P&L"}),e.jsx(v,{className:i("text-2xl",c.unrealizedPnl>=0?"text-green-600":"text-red-600"),children:d(c.unrealizedPnl)})]})}),e.jsx(p,{children:e.jsxs(P,{className:"pb-2",children:[e.jsx(S,{children:"Total P&L"}),e.jsx(v,{className:i("text-2xl",c.totalPnl>=0?"text-green-600":"text-red-600"),children:d(c.totalPnl)})]})})]}),h.length===0&&!z&&e.jsx(p,{children:e.jsx(N,{className:"py-12 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"No trades found for today"})})}),e.jsx("div",{className:"space-y-4",children:h.map(s=>{const t=_.has(s.name);return e.jsxs(p,{children:[e.jsxs(P,{className:"cursor-pointer flex flex-row items-center justify-between py-4",onClick:()=>I(s.name),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t?e.jsx(J,{className:"h-5 w-5 text-muted-foreground"}):e.jsx(X,{className:"h-5 w-5 text-muted-foreground"}),e.jsx(v,{className:"text-lg",children:s.name}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",s.legs.length," legs)"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Realized"}),e.jsx("div",{className:i("font-medium",s.totalRealizedPnl>=0?"text-green-600":"text-red-600"),children:d(s.totalRealizedPnl)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Unrealized"}),e.jsx("div",{className:i("font-medium",s.totalUnrealizedPnl>=0?"text-green-600":"text-red-600"),children:d(s.totalUnrealizedPnl)})]}),e.jsxs("div",{className:"text-right min-w-[100px]",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total"}),e.jsxs("div",{className:"flex items-center gap-1",children:[s.totalPnl>=0?e.jsx(Z,{className:"h-4 w-4 text-green-600"}):e.jsx(ee,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:i("font-bold",s.totalPnl>=0?"text-green-600":"text-red-600"),children:d(s.totalPnl)})]})]})]})]}),!t&&e.jsx(N,{className:"pt-0",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left py-2 font-medium",children:"Symbol"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Buy Qty"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Sell Qty"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Net Qty"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Avg Buy"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Avg Sell"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"LTP"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Realized"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"Unrealized"}),e.jsx("th",{className:"text-right py-2 font-medium",children:"P&L"})]})}),e.jsx("tbody",{children:s.legs.map((a,u)=>{const l=a.realizedPnl+a.unrealizedPnl;return e.jsxs("tr",{className:"border-b last:border-0 hover:bg-muted/50",children:[e.jsxs("td",{className:"py-2",children:[e.jsx("div",{className:"font-medium",children:a.symbol}),e.jsx("div",{className:"text-xs text-muted-foreground",children:a.exchange})]}),e.jsx("td",{className:"text-right py-2 text-green-600",children:a.buyQty||"-"}),e.jsx("td",{className:"text-right py-2 text-red-600",children:a.sellQty||"-"}),e.jsxs("td",{className:i("text-right py-2 font-medium",a.netQty>0?"text-green-600":a.netQty<0?"text-red-600":""),children:[a.netQty>0?"+":"",a.netQty]}),e.jsx("td",{className:"text-right py-2",children:a.avgBuyPrice>0?`₹${a.avgBuyPrice.toFixed(2)}`:"-"}),e.jsx("td",{className:"text-right py-2",children:a.avgSellPrice>0?`₹${a.avgSellPrice.toFixed(2)}`:"-"}),e.jsx("td",{className:"text-right py-2 font-medium",children:a.ltp>0?`₹${a.ltp.toFixed(2)}`:"-"}),e.jsx("td",{className:i("text-right py-2",a.realizedPnl>=0?"text-green-600":"text-red-600"),children:d(a.realizedPnl)}),e.jsx("td",{className:i("text-right py-2",a.unrealizedPnl>=0?"text-green-600":"text-red-600"),children:d(a.unrealizedPnl)}),e.jsx("td",{className:i("text-right py-2 font-bold",l>=0?"text-green-600":"text-red-600"),children:d(l)})]},u)})})]})})})]},s.name)})}),h.length>0&&e.jsx(p,{className:"bg-muted/50",children:e.jsx(N,{className:"py-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-medium",children:["Grand Total (",h.length," strategies, ",h.reduce((s,t)=>s+t.legs.length,0)," ","legs)"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-sm text-muted-foreground mr-2",children:"Realized:"}),e.jsx("span",{className:i("font-medium",c.realizedPnl>=0?"text-green-600":"text-red-600"),children:d(c.realizedPnl)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-sm text-muted-foreground mr-2",children:"Unrealized:"}),e.jsx("span",{className:i("font-medium",c.unrealizedPnl>=0?"text-green-600":"text-red-600"),children:d(c.unrealizedPnl)})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-sm text-muted-foreground mr-2",children:"Total:"}),e.jsx("span",{className:i("font-bold text-lg",c.totalPnl>=0?"text-green-600":"text-red-600"),children:d(c.totalPnl)})]})]})]})})})]})}export{xe as default};
